# 2025-12-04 マルバツ（TicTacToe）マルチプレイヤー実装計画

## 概要
ポーリング方式で既存のマッチング機能と一人用マルバツ実装を連携し、ログイン済みの2端末で対戦可能にする短期MVPの計画ドキュメント。
本計画は小さなタスクに分割し、各タスクごとにDoD（Definition of Done）と確認手順を明記する。

## 前提
- 実装方式: ポーリング（短期MVP）
- 実装中は main ブランチにいることを確認した後、新規ブランチを切る（例: `feat/marubatsu-multiplayer`）
- コード変更はこの計画に記載された範囲のみ行う

## 関連ファイル（ワークスペースルートからの相対パス）
- テンプレート／静的ファイル
  - `src/main/resources/templates/tictactoe.html`
  - `src/main/resources/templates/marubatsu.html`
  - `src/main/resources/templates/matching.html`
  - `src/main/resources/static/js/tictactoe.js`
- サーバサイド
  - `src/main/java/team1/saikyoapps/controller/`  内のマッチング関連コントローラ（例: `MatchingController` または `MatchController` を検索）
  - `src/main/java/team1/saikyoapps/config/SecurityConfig.java`
  - `src/main/java/team1/saikyoapps/` 以下に新規作成予定のクラス群（`model/Match.java`, `service/MatchService.java`, `controller/MatchController.java`）
- DBスキーマ
  - `src/main/resources/schema.sql`

## タスク一覧（優先度順・最小単位）
各タスクは小さく分割しています。実装はタスク1→2→3...の順で進めてください。

1) 影響範囲の確定（調査確認タスク） - 優先度: 高
   - 内容: 既存のマッチングコントローラ名・マッチング完了時の遷移処理を確認する。
   - 変更ファイル: なし（読み取りのみ）
   - DoD: `src/main/resources/templates/matching.html` と `src/main/java/team1/saikyoapps/controller/` 以下の該当メソッド名を特定し、該当ファイルパスをこのドキュメントに追記すること。
   - 検証手順: ファイルを開き、マッチング完了時にどのURLへリダイレクトしているかをスクリーンショットまたは抜粋として記録する。

2) データモデル設計（Matchモデルの最小設計） - 優先度: 高
   - 内容: サーバで扱う `Match` モデルを設計。最小フィールド: `matchId`(UUID), `player1Id`, `player2Id`, `board`(文字列9長/JSON), `turn`(playerId), `status`(waiting|playing|finished)、`createdAt`。
   - 変更ファイル: 新規 `src/main/java/team1/saikyoapps/model/Match.java`
   - DoD: クラスファイルが追加され、コンパイルエラーなし。
   - 検証手順: `./gradlew classes` でビルドし、エラーが出ない事を確認。

3) マッチ永続化（DBスキーマ更新） - 優先度: 中
   - 内容: 必要に応じて `schema.sql` に `match` テーブルを追加（簡易構成でOK）。
   - 変更ファイル: `src/main/resources/schema.sql`
   - DoD: テーブル作成DDLが記述され、既存のスキーマと整合すること（既存のDDLを上書きしない）。
   - 検証手順: アプリ起動時にDDLが適用されるか、`spring.datasource` の設定に沿ってDBを作成できることを確認する。

4) サービス実装（MatchService） - 優先度: 高
   - 内容: サーバ側で盤面更新・勝敗判定・妥当性チェックを行う最小実装。
   - 変更ファイル: 新規 `src/main/java/team1/saikyoapps/service/MatchService.java`
   - DoD: 指定の入力（match, playerId, pos）に対して期待する盤面更新と勝敗判定が行えること。ユニットテスト1件を用意する。
   - 検証手順: 単体テストを実行して勝敗判定のパターン（先手勝ち、引き分け、不正手）を確認する。

5) API実装（MatchController） - 優先度: 高
   - 内容: 以下のエンドポイントを実装
     - GET `/match/state?matchId=xxx` → {matchId, board, turn, status, winner?}
     - POST `/match/move` → body: {matchId, pos}（ログインユーザ情報はサーバ側で取得）
   - 変更ファイル: 新規 `src/main/java/team1/saikyoapps/controller/MatchController.java`（既存のコントローラがある場合は追記）
   - DoD: curl やブラウザで GET がJSONを返し、POST で盤面が更新されること。サーバ側でターンチェック・所有者チェックを行い不正な操作を拒否する。
   - 検証手順: ログイン済みの2つのブラウザセッションでPOST/GETを実行し、状態が同期することを確認。

6) マッチングとの連携（matching → marubatsu への matchId 引き渡し） - 優先度: 高
   - 内容: 既存のマッチング完了処理に `matchId` を渡し、`marubatsu.html` に渡す（クエリパラメータまたはテンプレート変数）。
   - 変更ファイル: 該当マッチングコントローラ、`src/main/resources/templates/marubatsu.html`
   - DoD: マッチング完了後、両端末が `/marubatsu?matchId=xxx` に遷移し、ページ内に `matchId` が埋め込まれていること（DOMまたはdata属性）。
   - 検証手順: マッチングを開始 → 相手が揃う → 両端末のURLとページ内matchIdを確認。

7) フロント実装（ポーリングとクリック送信） - 優先度: 高
   - 内容: 新規 `src/main/resources/static/js/marubatsu.js` を作成
     - ページロード時に `matchId` を読み取り、定期的に `/match/state` をGETして盤面を描画
     - クリック時に `POST /match/move` を送信（CSRFトークンを付与）
     - 終了時に勝敗表示と遷移処理を行う
   - 変更ファイル: `src/main/resources/templates/marubatsu.html`（scriptの読み込み・CSRF埋め込み）
   - DoD: 片方がクリックすると相手画面がポーリングで更新されること。ターンが正しく切り替わること。
   - 検証手順: 両端末で操作して状態同期と勝敗表示を確認。

8) テスト/統合検証 - 優先度: 高
   - 内容: End-to-end の動作確認を行う。スモークテストを自動化できれば追加。
   - DoD: ドキュメントのDoD項目（後述）を全て満たすこと。

9) ドキュメント更新 - 優先度: 中
   - 内容: 実装終了後に `docs/reports/done/done_YYYY-MM-DD_実装内容.md` と `docs/specs.md` を更新する。
   - DoD: 実装内容、確認手順、ブランチ名を `done` レポートに記載すること。

## 各タスクでの入力／出力／テスト方法（重要）
- 入力例（POST /match/move）
  - URL: POST `/match/move`
  - Headers: Cookie でログインセッション、CSRF トークン
  - Body(JSON): { "matchId": "<uuid>", "pos": 4 }
- 出力例（GET /match/state）
  - { "matchId": "<uuid>", "board": "XO X  O  ", "turn": "user1", "status": "playing", "winner": null }
- ログインはブラウザで通常のUIを使用して確認する。API は curl や Postman でも検証可能。

## ブランチ戦略と作業手順（実装前に必ず確認）
1. `git switch main` を実行し、最新の main を取得する（`git pull`）
2. 新規ブランチを作成: `git switch -c feat/marubatsu-multiplayer`（ブランチ名は任意だがプレフィックスは feat を推奨）
3. 小さなコミットで都度PRを作成し、レビューを行う

## セキュリティと運用上の注意
- CSRF: フロントでPOSTする際は Thymeleaf の `_csrf` を埋め込むこと
- 認可: サーバは match に紐づかないユーザからの操作を拒否すること
- ターン検証: サーバ側で必ず「現在のターンか」を検査すること

## DoD（最終受入基準）
以下の手順が手動で確認できれば本タスクは完了とする。
1. ブラウザAで userA でログイン→マルバツ選択→マッチング開始
2. ブラウザBで userB でログイン→マルバツ選択→マッチング開始
3. 両ブラウザが `/marubatsu?matchId=xxx` に遷移すること
4. プレイヤーAがマスを選ぶとプレイヤーBの画面に反映され、ターンが切り替わる
5. 勝敗判定が両端末で一致すること
6. 投了（戻る）ボタンでマッチが終了すること
7. 不正操作（相手のターンの移動等）はサーバが拒否すること

## 予想期間（目安）
- 影響範囲確認: 0.5日
- モデル/サービス/コントローラ実装と単体テスト: 1.5〜2日
- フロント実装・統合テスト: 1〜2日
- 合計: 約3〜4日（レビュー反映を除く）

## 次のアクション（私に実装して良いか）
この計画で実装を進めてよければ「実装開始してください」と返信してください。実装開始時に:
- main ブランチにいることを確認するよう促します（私がコマンドを実行します）

---
作業計画ファイル: `docs/personal_tasks/tasks_2025_12_04_マルバツ_マルチプレイヤー実装計画.md` を作成しました。
