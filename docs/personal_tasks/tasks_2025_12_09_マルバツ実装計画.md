# タスク: マルバツ（marubatsu）マルチプレイヤー実装計画

作成日: 2025-12-09

## 概要
五目並べの対戦実装を参考に、現状一人用のマルバツをマッチング／オンライン対戦対応に移行するための実装計画。段階的に実施し、各タスク完了時にDoDで動作確認を行う。

## 前提条件（必ず確認すること）
1. 作業前にリポジトリの `main` ブランチにいることを確認する（`git branch --show-current`）。
2. `main` から新規ブランチを作成して作業を行う（例: `feat/marubatsu-multiplayer`）。
3. 調査レポート `docs/reports/investigate/2025-12-09_マルバツ実装調査.md` を読了していること。

## 参照すべき既存ファイル（ワークスペースルートからの相対パス）
- saikyoapps/src/main/resources/templates/marubatsu.html
- saikyoapps/src/main/resources/static/js/marubatsu.js
- saikyoapps/src/main/java/team1/saikyoapps/controller/MatchingController.java
- saikyoapps/src/main/resources/schema.sql
- saikyoapps/src/main/java/team1/saikyoapps/controller/GomokuController.java
- saikyoapps/src/main/resources/templates/gomoku.html
- docs/reports/done/done_2025-12-08_五目並べ実装.md
- saikyoapps/src/main/java/team1/saikyoapps/model/MatchingQueue.java

（実装時は上記に加え、Mapper/Service 層の既存実装を検索して参照すること）

---

## タスク一覧（小さな単位に分割・優先度順）

1) ブランチ作成・環境準備（所要時間: 10分）
- 内容: `main` から `feat/marubatsu-multiplayer` ブランチを作成。
- 目的: 影響範囲を限定して実装するため。
- 関連ファイル: なし
- DoD: ブランチが作成され、ローカルに切り替わっていることを確認できる。

2) DB スキーマ設計とマイグレーション記述（所要時間: 30-60分）
- 内容: `schema.sql` に `marubatsu_game` と `marubatsu_move` の定義を追加し、既存の `match_history` へ書き込むフローを確認。
- 具体例（設計要素）:
  - marubatsu_game(game_id PK, board_state JSON, status VARCHAR, current_turn VARCHAR, player_x_id, player_o_id, created_at, updated_at)
  - marubatsu_move(move_id PK, game_id FK, player_id, x INT, y INT, symbol CHAR, created_at)
- 関連ファイル: saikyoapps/src/main/resources/schema.sql
- DoD: `schema.sql` に追記済みで、`./gradlew bootRun` 起動時にエラーが出ない（DDL に矛盾がない）ことを確認する。

3) サーバ側 API 仕様設計（所要時間: 30分）
- 内容: 既存の Gomoku API を参考にエンドポイントとリクエスト/レスポンスを定義する。
- 必須エンドポイント:
  - GET `/marubatsu/{gameId}` — ゲーム状態取得
  - POST `/marubatsu/{gameId}/move` — 落子処理
  - （既存のマッチングエンドポイントを流用）POST `/matching/marubatsu/start` など
- 出力: API 仕様の短いドキュメント（README 形式を推奨）
- 関連ファイル: saikyoapps/src/main/java/team1/saikyoapps/controller/GomokuController.java
- DoD: API 仕様ドキュメントを作成し、実装メンバーが参照できること。

4) サーバ実装 — Controller / Service / Mapper（所要時間: 3-5時間）
- 内容:
  - `MarubatsuController` を作成（GET/POST エンドポイント）
  - `MarubatsuService` にゲームロジック（落子妥当性・勝敗判定・引き分け判定）とトランザクションを実装
  - Mapper（MyBatis）または Repository を作成して `marubatsu_game` と `marubatsu_move` を永続化
- 関連ファイル（新規/変更）:
  - saikyoapps/src/main/java/team1/saikyoapps/controller/MarubatsuController.java
  - saikyoapps/src/main/java/team1/saikyoapps/service/MarubatsuService.java
  - saikyoapps/src/main/java/team1/saikyoapps/mapper/MarubatsuMapper.java
- テスト: サービス層の単体テストを作成
- DoD: GET/POST が実装され、簡易 curl で落子が保存されること（DB にレコードが追加されること）を確認する。

5) クライアント実装 — テンプレートと JS（所要時間: 2-4時間）
- 内容:
  - `templates/marubatsu.html` と `static/js/marubatsu.js` を五目並べの実装に合わせて修正／作成
  - 3x3 の盤面描画、クリックでの落子送信、ポーリングでゲーム状態取得
  - CSRF トークンを meta タグから取得して POST に付与
- 関連ファイル: saikyoapps/src/main/resources/templates/marubatsu.html, saikyoapps/src/main/resources/static/js/marubatsu.js
- DoD: 2 台のブラウザで同一 `gameId` を開き、一方が着手するともう一方に反映されること（ポーリングで更新されること）。

6) 認証・セキュリティ対応（所要時間: 1時間）
- 内容: POST で送られてくる playerId を信用せず、`Authentication` の principal からプレイヤーを判別する実装にする。CSRF トークンの確認。
- 関連ファイル: Controller の POST 実装部分、テンプレート
- DoD: 不正な playerId を投げたリクエストが拒否されること、CSRF トークンが必要であることを確認する。

7) テスト・統合テスト（所要時間: 2-3時間）
- 内容: サービス層のユニットテスト、マッチング→対戦→勝敗記録の統合テストを作成。
- 関連ファイル: src/test/java/team1/saikyoapps/...
- DoD: テストが通過すること（`./gradlew test` が成功すること）。

8) ドキュメント更新と完了報告（所要時間: 30分）
- 内容: 実施後、`docs/reports/done/done_YYYY-MM-DD_マルバツ実装.md` を作成し、`docs/specs.md` を更新。
- DoD: 完了報告が `docs/reports/done/` に追加され、`docs/specs.md` に実装を反映していること。

---

## 各タスクの検証手順（簡易チェックリスト）
- ブランチ作成: `git branch` でブランチ名を確認
- DB マイグレーション: `./gradlew bootRun` を実行して起動エラーがないか確認
- API: `curl -X GET http://localhost:8080/marubatsu/{gameId}` で JSON が取得できる
- 落子: `curl -X POST -H 'Content-Type: application/json' --data '{"x":0,"y":1}' http://localhost:8080/marubatsu/{gameId}/move` でステータス 200 を返す
- クライアント: 2 台のブラウザで操作し、盤面同期を確認
- テスト: `./gradlew test` が成功する

---

## 優先度と見積
- 優先度: 1ブランチ作成、2スキーマ、3API設計、4サーバ実装、5クライアント実装、6セキュリティ、7テスト、8ドキュメント
- 合計見積: 約10〜15時間（実装者の熟練度に依存）

---

## 次のアクション（選択してください）
- A: 実装を開始する（実装フェーズへ移行） — この場合、実装前に `main` にいることを確認してください。
- B: 先に既存のマルバツ関連ファイルを抜粋して差分調査する（templates/js/controller の抜粋）
- C: スキーマ定義案を作成する（`schema.sql` の変更案を作成）

希望する次のアクションを指示してください。
