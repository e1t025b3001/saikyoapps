計画：五目並べ（Gomoku）実作計画（中文）

作成日: 2025-12-07
作成者: GitHub Copilot
対象ブランチ: feature/gomoku（この計画は feature/gomoku ブランチ上での実装を想定）

目的
- 五目並べの実際の対戦画面を実装し、対戦の履歴とゲームセッション情報をDBに保存する。
- 対戦は players_status が playing のときにのみ開始される。
- 対戦中の手（着手）は即時に相手へ反映されること（WebSocket 推奨）。

全体方針（順序）
1) 調査（完了）
2) 計画（このファイル）
3) 実装（段階的に小分けタスクを順に実施）
4) テスト・検証（DoD に基づく確認）

注意事項（公開DB/既存データ）
- 既存の matching_queue, players_status などの既存テーブルは維持しつつ、新規にゲーム専用テーブルを追加する。
- 既存データを破壊しない実装を優先。勝敗記録を match_history に保存後、ゲームセッションのデータは要件に従い削除するか "finished" マークを付ける。

関連ファイル（実装で変更/追加する予定）
- DB スキーマ: `src/main/resources/schema.sql`
- モデル: `src/main/java/team1/saikyoapps/model/GomokuGame.java`, `GomokuMove.java`, `MatchHistory.java`
- MyBatis mapper: `src/main/java/team1/saikyoapps/model/GomokuGameMapper.java`, `GomokuMoveMapper.java`, `MatchHistoryMapper.java`
- コントローラ: `src/main/java/team1/saikyoapps/controller/GomokuController.java`（REST と WebSocket のブリッジ）
- WebSocket 設定: `src/main/java/team1/saikyoapps/config/WebSocketConfig.java`
- テンプレート: `src/main/resources/templates/gomoku.html`
- 静的JS: `src/main/resources/static/js/gomoku.js`
- ドキュメント: `docs/reports/done/done_YYYY-MM-DD_五目並べ実装.md`（完了報告）

タスク分解（最小実行単位）

タスク 1: DB テーブル定義を追加
- 内容:
  - schema.sql に以下を追加: `gomoku_game`, `gomoku_move`, `match_history`（調査で提案した定義に準ずる）
- 関連ファイル:
  - `src/main/resources/schema.sql`
- DoD:
  - 起動時（./gradlew bootRun）に DB にテーブルが作成されること。
  - H2 Console で `SELECT * FROM gomoku_game;` が実行できること。
- 実行手順（想定コマンド）:
  - 編集後 `./gradlew bootRun` でアプリ起動、H2 Console で確認。

タスク 2: Model と Mapper を追加
- 内容:
  - GomokuGame, GomokuMove, MatchHistory の Java クラスを作成。
  - MyBatis の Mapper インターフェースを作成（insert/find/update/delete に必要なメソッドを定義）。
- 関連ファイル:
  - `src/main/java/team1/saikyoapps/model/GomokuGame.java`
  - `src/main/java/team1/saikyoapps/model/GomokuMove.java`
  - `src/main/java/team1/saikyoapps/model/MatchHistory.java`
  - `src/main/java/team1/saikyoapps/model/GomokuGameMapper.java`
  - `src/main/java/team1/saikyoapps/model/GomokuMoveMapper.java`
  - `src/main/java/team1/saikyoapps/model/MatchHistoryMapper.java`
- DoD:
  - Mapper のメソッドがコンパイルを通ること。
  - 単純な insert/find のユニットテスト（またはアプリ起動時に SQL 実行）でレコードの追加・取得が可能であること。

タスク 3: MatchingController の拡張（配対成立時に game session を作成）
- 内容:
  - 既存の MatchingController を修正し、配対が成立したタイミングで gomoku_game のレコードを作成する（gameId を発行、player_black/player_white を保存、先手ランダム決定）
  - players_status は既に playing に設定されていることを利用
- 関連ファイル:
  - `src/main/java/team1/saikyoapps/controller/MatchingController.java`（変更）
  - `src/main/java/team1/saikyoapps/model/GomokuGameMapper.java`
- DoD:
  - 配対成立時に `gomoku_game` に新規レコードが作成されることを H2 Console で確認できること。
  - 作成された gameId を使ってクライアントが該当ゲームページへ遷移できること。

タスク 4: WebSocket の設計と実装（サーバ）
- 内容:
  - Spring で WebSocket（STOMP もしくは生 WebSocket）を設定し、/ws/gomoku エンドポイントを用意
  - サーバで gameId ごとのセッション管理（接続ユーザの登録、切断時の処理）を実装
  - MOVE メッセージを受け取ったらバリデーション・保存・勝敗判定・ブロードキャストを行う
- 関連ファイル:
  - `src/main/java/team1/saikyoapps/config/WebSocketConfig.java`
  - `src/main/java/team1/saikyoapps/controller/GomokuWebSocketHandler.java`（または STOMP 用 Controller）
- DoD:
  - クライアントが WS に接続して JOIN できること。
  - A が送った MOVE を B が受け取り、画面に反映されること（実装確認）。

タスク 5: Frontend 実装（gomoku.html + gomoku.js）
- 内容:
  - gomoku.html: 15x15 の棋盤描画と UI（プレイヤー名、回合表示、放棄ボタン）を作成
  - gomoku.js: WebSocket 接続、MOVE 送信、受信時の UI 更新、勝敗表示と 5 秒後ホームへ遷移
- 関連ファイル:
  - `src/main/resources/templates/gomoku.html`
  - `src/main/resources/static/js/gomoku.js`
- DoD:
  - クリックで着手 → WS 経由で相手画面にリアルタイム反映
  - 勝敗判定後、両者に勝敗表示が出て 5 秒でホームに戻る

タスク 6: 結果保存とクリーンアップ
- 内容:
  - 勝敗確定時に match_history に結果を記録
  - 要件に従いゲーム実績テーブル（gomoku_game, gomoku_move）を削除するかフラグで "finished" にする（実装方針を決める）
- 関連ファイル:
  - `src/main/java/team1/saikyoapps/model/MatchHistoryMapper.java`
- DoD:
  - 勝敗確定後、match_history に新規レコードが追加されること
  - players_status が両者とも lobby に戻ること
  - （要件: 削除する場合）gomoku_game / gomoku_move の該当データが削除されていること

タスク 7: ドキュメントとテスト
- 内容:
  - docs/reports/done/done_YYYY-MM-DD_五目並べ実装.md を作成し、実装内容と DoD 検証手順を記録
  - 手動テスト手順書と必要なユニットテストを作成
- 関連ファイル:
  - `docs/reports/done/done_YYYY-MM-DD_五目並べ実装.md`
- DoD:
  - 手順に沿って QA 確認ができ、DoD が満たされること

作業順と見積り（粗い）
- タスク1: 1日
- タスク2: 1日
- タスク3: 0.5〜1日
- タスク4: 2日
- タスク5: 1〜2日
- タスク6: 0.5日
- タスク7: 0.5日

合計概算: 6〜8 営業日（並行作業とテスト含む）

実装上の注意（優先事項）
- データ整合性: move の挿入と勝敗判定はトランザクションで扱い、同一セルへの重複書き込みを防止する。
- 認証: WebSocket 接続時も必ず認証情報（session cookie）で接続確認を行う。
- ログ: 重要なイベント（創建 game, move, end, forfeit）はログに残す。

次のアクション（選択肢）
- 「実作開始」: 私がタスク1 から順に実装していきます（私がファイルを編集してコミット/プッシュの指示を出す）→ 回答：「実作」
- 「細分化の再調整（見積り/順序調整）」: タスクをさらに細分化して優先度調整する → 回答：「微調整」
- 「保留/相談」: 他の優先事項に移る → 回答：「保留」
