# 2025-12-21 i18n 実装レビュー

対象ブランチ: feat/i18n-ja-zh-TW

実施者: GitHub Copilot

目的
- ホーム画面の言語切替（日本語 / 繁体字）機能の追加実装について、追加・変更・新規作成したファイルをレビューし問題点・改善点を列挙する。

対象ファイル（ワークスペースルートからの相対パス）
- src/main/java/team1/saikyoapps/config/LocaleConfig.java (新規)
- src/main/resources/i18n/messages_ja.properties (新規)
- src/main/resources/i18n/messages_zh-TW.properties (新規)
- src/main/resources/i18n/messages_zh_TW.properties (新規)
- src/main/java/team1/saikyoapps/controller/HomeController.java (変更)
- src/main/resources/templates/index.html (変更)
- src/main/java/team1/saikyoapps/model/I18nConfig.java (変更)
- src/main/java/team1/saikyoapps/model/I18nConfigMappaer.java (既存/参照確認)

レビュー概要（要点）
- 全体として実装方針は妥当。Spring の MessageSource を導入し、ユーザごとの設定を DB に保存する流れ、PRG を使った反映、CSRF 対応は適切。
- ただしロケールの表記の不整合、メッセージファイルの重複、モデル・Mapper の整合性、セッションへの Locale 設定の箇所で注意点があるため修正を推奨する。

ファイル毎の指摘と修正案（短く）

1) src/main/java/team1/saikyoapps/config/LocaleConfig.java
- 指摘: MessageSource と SessionLocaleResolver が定義されており正しい。
- 推奨: コメントでデフォルト Locale と basename の説明を追記すると運用時に分かりやすい。

2) src/main/resources/i18n/messages_ja.properties
- 指摘: 日本語メッセージが追加されている（title）。問題なし。
- 推奨: 将来の拡張に備え key 名規約（例: page.index.title）を採用すると良い。

3) src/main/resources/i18n/messages_zh-TW.properties および messages_zh_TW.properties
- 指摘: 同義のファイルがハイフン版とアンダースコア版で存在している。MessageSource は通常アンダースコア形式（messages_zh_TW.properties）を期待するため、重複は混乱を招く。
- 重大度: 中
- 修正案: 1つに統一する（推奨: messages_zh_TW.properties を残し、 messages_zh-TW.properties を削除）。フォーム・コントローラの locale 値も同一表記に統一する（zh_TW を推奨）。

4) src/main/java/team1/saikyoapps/controller/HomeController.java
- 指摘:
  - LocaleResolver 注入と PRG 実装は適切。
  - ロケール比較で "zh_TW" を使う実装に変更済みだが、フォームの値や MessageSource のファイル名と完全に一致しているか確認が必要。
  - setI18n メソッドで jakarta.servlet の HttpServletRequest/Response を使用している。プロジェクトの他のコードが javax.servlet から jakarta に移行済みか確認してください（Spring Boot のバージョン依存）。
  - コントローラ内で直接 System.err.println を使ったログ出力をしているが、将来的には Logger（SLF4J）を使うべき。
- 重大度: 中
- 修正案:
  - ロケール表記を一箇所に集約（定数化）する。
  - System.err を Logger に置換する。
  - jakarta パッケージの使用が問題となる場合は javax.servlet を使うか、Spring Boot のバージョンを確認する。

5) src/main/resources/templates/index.html
- 指摘:
  - CSRF トークンがフォームに追加されている（良い）。
  - 保存ボタン表示判定を data 属性にして JS で判定する実装は堅牢。
  - h1 を i18n_title に変更したが、Thymeleaf の inlining の使い方やエンコーディングが正しく設定されているか確認してください（application.properties の encoding 設定は存在する）。
- 推奨: JS における選択肢の value はロケール表記に合わせて統一済みか確認。

6) src/main/java/team1/saikyoapps/model/I18nConfig.java
- 指摘: フィールド名を loginUser に変更して Mapper の alias に合わせた点は整合的。ただし他のコードが旧フィールド名（user）を参照している可能性があるため検索して影響範囲を確認してください。
- 修正案: プロジェクト内で getUser()/setUser() を参照している箇所があれば修正するか、I18nConfig に両方の getter/setter を残して互換性を保つ。

7) src/main/java/team1/saikyoapps/model/I18nConfigMappaer.java
- 指摘: Mapper の SQL で login_user カラムを使うのは schema.sql と一致する想定で OK。
- 推奨: insert/update の戻り値を int にして影響行数を受け取るとデバッグしやすい（現状 void）。

動作確認ポイント
- 実行: gradle bootRun
- フロー: ログイン -> ホームでラジオ選択 -> 保存 -> リダイレクトで / を再取得 -> タイトルが翻訳されること
- DB: H2 コンソールまたは JDBC を使い i18n_config テーブルの login_user と locale の値を確認すること

セキュリティ・運用上の注意
- ログに平文でユーザ名を出している個所がある（デバッグ用）。本番にマージする前にログレベルと出力内容を見直してください。
- 追加した翻訳ファイルは UTF-8 で保存されていることを確認済みだが、各 OS やエディタでエンコーディングが壊れる場合があるため CI でのチェックを推奨します。

結論と推奨アクション（短く）
1. messages_zh-TW.properties を削除して messages_zh_TW.properties に統一する（locale 表記を zh_TW に揃える）。
2. HomeController 内の文字列ロケールは定数化し、System.err を Logger に変更する。
3. I18nConfig の後方互換のため getUser()/setUser() を残すか、参照箇所をすべて修正する。
4. Mapper の insert/update を int 戻り値に変更して影響行数を検証可能にする。
5. 変更後に gradle bootRun で完全な動作確認を行う（DoD に従う）。

レビュー終了。
