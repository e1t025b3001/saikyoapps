# 2025-11-24 鋤大D（大老二）実装調査（台湾ルール採用・3人固定）

## 目的
台湾ルールに基づく鋤大D（大老二）のルールを本プロジェクトで実装するため、要件・配牌方法・比較ルール・実装上の注意点を明確化する。実装対象はプレイ人数を 3 人に固定する。

## 採用ルール（今回の確定仕様）
- ルールセット: 台湾ローカルルールを採用する（以後「本ルール」と記載）。地域差のある要素は本ドキュメントで明確に定義する。
- 使用カード: 標準 52 枚デッキ（ジョーカー無し）。
- プレイ人数: 3 人で固定。ボットを含む形で UI/サーバ側でプレイ可能とする。
- 配牌（カード配布）:
  - 52 枚を配るとき、52 ÷ 3 = 17 余り 1。余った 1 枚は「3♣ を持つプレイヤー」に渡す（そのプレイヤーは 18 枚、他は 17 枚）。
  - 初期先手は 3♣ を持つプレイヤーとする（配牌後に 3♣ を持っていることが判明するプレイヤーが先手）。
- スートの強さ（同ランク比較時）: ♠ > ♥ > ♦ > ♣ の順で強い（台湾ルールに合わせて指定）。
- ランクの強さ（低→高）: 3 < 4 < 5 < 6 < 7 < 8 < 9 < 10 < J < Q < K < A < 2。つまり 3 が最弱、2 が最強。
- 出し方（許容する出し役）:
  - シングル（1 枚）
  - ペア（同ランク 2 枚）
  - スリーカード（同ランク 3 枚）
  - 5 枚役（ポーカータイプ）: ストレート、フラッシュ、フルハウス、フォー・オブ・ア・カインド＋キッカー、ストレートフラッシュ
  - それ以外の複雑役（例: 連番ペアなど）は初期実装ではサポート対象外とする（将来的に拡張可能）。
- 出しの流れ（基本ルール）:
  - 先手は 3♣ を持つプレイヤー。
  - 以降、時計回りにターンが回る（実装上はプレイヤー配列の次インデックスをターンにする）。
  - プレイヤーは現在場の出し（カテゴリ）と同じカテゴリでそれより強い手を出すか、パスする。
  - 全員がパスした場合、場は流れ（パスをリセット）し、最後に出したプレイヤーが次の先手となる。
  - 勝者（ゲーム終了条件）: 誰かの手札が 0 枚になった時点でゲーム終了とする（1 人でも手札を使い切ればゲーム終了）。

## 比較ルールの詳細（明確化）
- シングル/ペア/スリー:
  - ランクが異なる場合はランクで比較（より大きいランクが勝ち）。
  - ランクが同じ場合はスートの強さで比較する。ペア・スリーでは、比較対象の中で最も強いカード（通常は任意の基準で決められるが、実装上は最大のスートを持つカードを比較キーとする）を用いてスート比較を行う。具体的には、同ランクのペア同士を比較する場合、各ペア内で最も強いスートのカードを取り、そのスート順で勝者を決める。
- 5 枚役:
  - まずポーカー風手役の強さで比較（ストレート < フラッシュ < フルハウス < フォーカード+キッカー < ストレートフラッシュ の順）。
  - 同じ手役内で比較する場合は、役の判定で用いる代表的なランク（例: フルハウスならトリプルのランク、ストレートならストレートの最高ランクなど）を比較し、ランクが同じならスート順で決める（スートの比較は代表カードのスートを用いる）。

（注）5 枚役の細かい同値処理は実装時にユニットテストで明確化するが、基本方針は「役 → 代表ランク → スート」の順で比較する。

## 実装上の注意点（本ルールに基づく）
- 配牌ロジック: 3 人固定で余り 1 枚を 3♣ 保有者に渡すため、配牌処理は「配る → 3♣ を確認 → 余りカードを 3♣ 所有者に追加」の流れにする。配牌中に 3♣ が配られていない場合（理論上あり得ないが実装確認用のガードを入れる）を考慮する。
- 先手決定: 配牌完了時に 3♣ を持つプレイヤーを先手としてターンを初期化する。
- 手役判定と比較: 5 枚役の判定・比較はバグになりやすい箇所のため、ユニットテストを充実させる（各種役ごとの勝敗テスト、同値ケースの処理）。
- スート順の扱い: 同ランクでスート順が勝敗に影響するため、Card クラスなどでスートに優先度を持たせる（内部整数値で ♣=0, ♦=1, ♥=2, ♠=3 など）。
- 人数固定化の利点: 3 人固定により配牌・ターン管理・UI 表示が簡潔になる。将来的に 4 人対応を追加する場合は配牌と先手決定ロジックを拡張する。
- 終了条件: 誰かが手札を使い切った時点で即時終了とする（複数人同時に 0 枚になることは配牌枚数の関係上 3 人プレイでは起きにくいが、念のため処理は最初に 0 枚になったプレイヤーを勝者とする実装で良い）。

## 簡略化方針（実装難易度を考慮しつつ原則維持）
ユーザ希望どおり可能な限り本来のルールを維持するが、実装負荷の高い箇所は下記の通り簡略化を許容する。

- 優先的に維持する点:
  - 台湾ルールのスート順・先手・配牌（余りの 1 枚を 3♣ 所有者に渡す）・終了条件は必須で実装する。
  - シングル・ペア・スリー・5 枚役（主要なポーカー役）は実装対象とする。
- 簡略化してよい点:
  - 連番のペアや特殊な複合役などローカルルールでのみ用いられる例外役は初期実装で除外する。
  - 同時マルチクライアント同期（WebSocket）は初期は短ポーリングや人間+ボット方式で代替する。

## 推奨アーキテクチャ（本ルール向け）
- model:
  - Card（ランク・スート・スート優先度）
  - Deck
  - Player（手札、名前、isBot フラグ）
  - Hand（出し役を表現するクラス階層: Single/Pair/Triple/FiveCardHand）
  - GameState（プレイヤー配列、場の状態、現在の先手、最後に出した手）
- service:
  - GameService（配牌、ターン進行、手役判定、比較、勝者判定）
  - BotPlayer（簡易 AI、まずはランダムまたは最小構成で妥当な手を出す）
- controller:
  - GameController（HTTP エンドポイント: ゲーム作成、参加、手を出す、パス）
- view:
  - Thymeleaf テンプレート `game.html` と簡易 JS（短ポーリング）

## 必要な変更ファイル（想定・相対パス）
- Java ソース
  - `saikyoapps/src/main/java/team1/saikyoapps/model/Card.java`
  - `saikyoapps/src/main/java/team1/saikyoapps/model/Deck.java`
  - `saikyoapps/src/main/java/team1/saikyoapps/model/Hand.java`
  - `saikyoapps/src/main/java/team1/saikyoapps/model/GameState.java`
  - `saikyoapps/src/main/java/team1/saikyoapps/service/GameService.java`
  - `saikyoapps/src/main/java/team1/saikyoapps/service/BotPlayer.java`
  - `saikyoapps/src/main/java/team1/saikyoapps/controller/GameController.java`
- テンプレート／静的リソース
  - `saikyoapps/src/main/resources/templates/game.html`
  - `saikyoapps/src/main/resources/static/js/game.js`
- テスト
  - `saikyoapps/src/test/java/team1/saikyoapps/GameLogicTests.java`

## テスト項目（DoD）
1. 配牌確認: 3 人に対して 18/17/17 の配布が行われ、3♣ 所有者に 18 枚配られることを確認する（ユニットテスト）。
2. 先手確認: 配牌後に 3♣ を持つプレイヤーが先手になっていること（統合テスト）。
3. 合法手のチェック: シングル・ペア・スリー・5 枚役の判定が正しいこと（ユニットテスト）。
4. 比較ロジック: 同カテゴリ内でのランク比較・スート比較が本ルールに従って正しく動作すること（ユニットテスト）。
5. ターン進行: パス処理、場の流れ、先手の移動が正しく行われること（統合テスト）。
6. 終了判定: あるプレイヤーの手札が 0 になったとき即座にゲームが終了すること（統合テスト）。
7. ボット動作: ボットが順に動き、ゲームが進行すること（統合テスト）。

## 実装工数見積（更新）
- 基本ゲームロジック（手役判定、比較）: 2–4 日（5 枚役の検証を重視）
- ボット実装（簡易）: 1–2 日
- HTTP コントローラ + テンプレート（基本 UI）: 1–2 日
- テスト・調整: 1–2 日
- 合計（人間+ボット、短ポーリング）: 5–10 日程度

## 残課題 / 実装時の決定事項
- 5 枚役の同値ケース（例: 同じストレートで最高ランクが同一の場合の比較）での代表カードの取り扱いを実装前に厳密に決め、ユニットテストを作成する。
- UI 上でのカード表示順（スート優先かランク優先か）を揃える。内部比較ロジックと表示順を一致させること。

---
作成者: GitHub Copilot
作成日: 2025-11-24

次のアクション: この仕様でよければ「計画」フェーズに進み、`docs/tasks.md` に具体的な実装タスクを作成します。
