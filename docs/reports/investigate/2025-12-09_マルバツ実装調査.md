# 調査報告: マルバツ（Tic-Tac-Toe）対戦実装調査

作成日: 2025-12-09

## 目的
現在リポジトリに一人用（ローカル）として実装されているマルバツ（marubatsu）を、既に実装済みの五目並べ（Gomoku）の対戦実装を参考にして、マルチプレイヤー（オンライン対戦／マッチング）対応の本実装へ移行するための調査報告を作成する。

## 調査対象ファイル（参照元）
- `saikyoapps/src/main/resources/templates/gomoku.html`（クライアントUI・ポーリング実装）
- `saikyoapps/src/main/java/team1/saikyoapps/controller/GomokuController.java`（サーバ側 API 実装）
- `docs/reports/done/done_2025-12-08_五目並べ実装.md`（実装方針・動作確認手順）
- マイグレーション済みの DB スキーマ（`schema.sql` に `gomoku_game` 等があることを確認）

※ マルバツ関連の現状コード（テンプレート/コントローラ/テスト）も併せて参照して差分を抽出する必要がある。

## 現状の想定（発見事項）
- 五目並べはマッチングと対戦状態管理、落子の保存、盤面の JSON 保存、ポーリングによるクライアント更新を最小実装している。
- マルバツは現状一人用（ローカルなゲームロジック）として動作しており、マッチングや落子の永続化・共有、複数クライアント間の同期を行う API が未実装である。
- 五目並べ実装はサーバ側でゲームID、盤面状態、move履歴を DB に持つ設計を採用しているため、同様の設計をマルバツに適用できる。

## 必要となる変更点（上位レベル）
1. DB スキーマ
   - `marubatsu_game` テーブル: game_id, board_state(JSON), status(enum: waiting/playing/finished), current_turn, created_at, updated_at など。
   - `marubatsu_move` テーブル: move_id, game_id, player_id, x, y, symbol(X/O), created_at など。
   - 既存の `match_history` テーブルへの書き込み（勝敗記録）を行う。

2. サーバ API
   - GET `/marubatsu/{gameId}`: ゲーム状態取得（boardState, currentTurn, status, winner など）。
   - POST `/marubatsu/{gameId}/move`: 落子処理（player識別、妥当性チェック、DB保存、勝敗判定、status更新）。
   - POST `/matching/marubatsu/start`（既存マッチング機構を流用）: マッチング開始/参加。
   - マッチング状態のポーリングエンドポイント（既存 `/matching/status` を利用可能であれば流用）。

3. サーバ内部設計
   - Controller 層: 既存 `GomokuController` を参考に `MarubatsuController` を新設または拡張。
   - Service 層: ゲームロジック（落子の妥当性/勝利判定/引き分け判定）とトランザクション処理を実装。
   - Repository/Mapper: MyBatis Mapper または JPA Repository を用いて `marubatsu_game` / `marubatsu_move` の CRUD を実装。

4. クライアント（テンプレート）
   - `templates/marubatsu.html` を作成または既存テンプレートを拡張し、Canvas/DOM で 3x3 盤面を描画。
   - CSRF トークン対応（meta タグから取得して POST に付与）を五目並べと同様に実装。
   - ポーリングまたは WebSocket によるゲーム状態取得（最短で動かすなら五目並べと同様にポーリングを採用）。

5. セキュリティ / 認証
   - POST エンドポイントで送信者を信頼せず、Authentication の principal からプレイヤーIDを取得してプレイヤー識別を行うことを推奨。
   - CSRF 対策をテンプレート側で行う（既存実装に合わせる）。

6. テスト
   - 単体テスト: サービス層の勝敗判定ロジック、妥当性チェック。
   - 統合テスト: マッチング→対戦開始→落子→勝敗記録までのフローを模擬する統合テスト。

## 実装上の懸念点と解決案
- 同期遅延（ポーリング方式）: 短期的にはポーリングで実装し、将来的に STOMP/WebSocket に置換する予定を明文化する。
- トランザクション: 同一セルへの同時着手の競合は DB トランザクションとアプリ側の妥当性チェックで防止する。悲観ロック／楽観ロックの検討が必要。
- プレイヤー識別の不整合: クライアント送信の playerId による識別は避け、認証情報を使うこと。

## 参照すべき実装/ファイル一覧（ワークスペースルートからの相対パス）
- `saikyoapps/src/main/java/team1/saikyoapps/controller/GomokuController.java`（参考: API 形、例外処理）
- `saikyoapps/src/main/resources/templates/gomoku.html`（参考: クライアント側ポーリング・CSRF 対応）
- `saikyoapps/src/main/resources/schema.sql`（参考: gomoku 用テーブル定義）
- `docs/reports/done/done_2025-12-08_五目並べ実装.md`（参考: 実装方針・DoD）
- マルバツの現状ファイル（テンプレート/コントローラ）の検索を推奨（例: `templates/marubatsu.html`, `MarubatsuController` など）

## 推奨実施手順（短期・実装の流れ）
1. 現在の `main` ブランチから `feat/marubatsu-multiplayer` のようなブランチを作成。
2. DB スキーマ追加: `marubatsu_game` / `marubatsu_move` を `schema.sql` に追記（マイグレーション手順を記述）。
3. サーバ: `MarubatsuController` + `MarubatsuService` + Mapper を最小実装（五目並べと同様の API 仕様で実装）。
4. クライアント: `templates/marubatsu.html` を作成し、ポーリング版でまず動作確認。
5. テスト: サービス層の単体テスト、統合テストを追加。
6. 動作確認手順を `docs/reports/done/done_YYYY-MM-DD_マルバツ実装.md` に記載して完了報告。

## DoD（Definition of Done）例
- サーバを起動して、2 台のブラウザで別アカウントでログイン後、マッチング開始→playing→`gameId` を受け取ること。
- 片方が着手するとサーバに保存され、両端末の盤面が反映されること。
- 勝敗が確定したら `match_history` に記録され、両端末に結果が表示されること。
- セキュリティ: POST は CSRF 対策済みであり、プレイヤー識別は認証情報に基づくこと。

## 推奨改善（任意）
- ポーリングを STOMP/WebSocket に置換して低遅延化。
- ゲームルーム管理の拡張（観戦モード、再戦機能）。
- 既存のマッチングロジックの共通化（Gomoku と Marubatsu で共有するサービス層の抽象化）。

## 参考 URL / 参照メモ
- `docs/reports/done/done_2025-12-08_五目並べ実装.md`（五目並べ実装完了報告）
- `saikyoapps/src/main/resources/templates/gomoku.html`
- `saikyoapps/src/main/java/team1/saikyoapps/controller/GomokuController.java`

---

調査は以上です。次の指示（例: 計画作成 / 実装開始 / 既存ファイルの検索と抜粋）をお願いします。
