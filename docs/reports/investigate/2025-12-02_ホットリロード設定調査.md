# 2025-12-02 ホットリロード（Hot reload / 自動再読み込み）設定調査

目的
- 実行中の Spring Boot アプリケーションを停止せずに、ソースやテンプレート、静的リソースの変更をブラウザに反映させるための設定と手順を調査する。

結論（推奨構成）
1. 開発専用ライブラリとして Spring Boot DevTools を導入する（自動再起動 + LiveReload サーバを提供）
2. Thymeleaf や静的リソースのキャッシュを無効化する（テンプレート/静的ファイルを即時反映）
3. ソース（Java）変更で再起動をトリガーするため、編集内容がコンパイル済みクラスに反映されるように IDE の自動ビルド機能か Gradle の継続ビルド（--continuous）を併用する
4. ブラウザ自動更新は DevTools の LiveReload を使う（ブラウザ拡張でも可）

想定する変更ファイル
- `saikyoapps/saikyoapps/build.gradle` への依存追加（`developmentOnly 'org.springframework.boot:spring-boot-devtools'`）
- `saikyoapps/saikyoapps/src/main/resources/application.properties`（または `application.yml`）への開発向け設定追加
- （任意）VS Code の設定や Gradle ターミナルでの継続ビルド起動スクリプト

詳述
1) Spring Boot DevTools
- 役割: ソースのクラスパス変更を監視して自動的にアプリケーションを再起動（restart）し、静的リソースやテンプレートの変更があれば LiveReload を通じてブラウザを自動更新できる。
- 追加方法（Gradle）: `build.gradle` の `dependencies` に以下を追加する（開発環境専用にするため `developmentOnly` を利用）

  developmentOnly 'org.springframework.boot:spring-boot-devtools'

- 注意: 本ライブラリは開発専用。プロダクションに含めないようにする。

2) テンプレートと静的リソースのキャッシュ無効化
- Thymeleaf のキャッシュを無効化する（テンプレートの即時反映）:
  - `spring.thymeleaf.cache=false`
- 静的リソースのキャッシュ期間を 0 にする（ブラウザ側キャッシュ挙動にも依存するが、Spring側のキャッシュを無効化）:
  - Spring Boot 3 系: `spring.web.resources.cache.period=0`
- DevTools の LiveReload を有効にする設定（通常デフォルトで有効）:
  - `spring.devtools.livereload.enabled=true`

3) Java ソース変更時の自動再起動のトリガー
- DevTools はビルド済みクラスファイルの変更を監視して再起動を行うため、ソース編集後にコンパイル済みクラス（build/classes/...）が更新される必要がある。
- 推奨方法:
  - IDE の自動ビルド（保存時に自動コンパイル）を有効にする。例: IntelliJ の場合は「Build project automatically」を有効化（加えて Registry の `compiler.automake.allow.when.app.running` を true にする必要あり）。
  - VS Code の場合: Java 拡張の自動ビルドや保存時に `javac` を走らせる設定を利用できるが環境差があるため、確実な方法として Gradle の継続ビルドを併用する。
- Gradle 継続ビルド例（別ターミナルで実行）:
  - `./gradlew -t classes` または `./gradlew -t compileJava`
  - これによりソース変更時に自動でコンパイルが走り、DevTools が検知してアプリを再起動する。

4) ブラウザの自動更新（LiveReload）
- DevTools は内蔵の LiveReload サーバを起動し、ブラウザ側で LiveReload クライアントが接続されているとページリロードが行われる。
- ブラウザで自動リロードさせる方法:
  - 推奨: ブラウザに LiveReload 拡張 (LiveReload extension) を入れる。拡張を有効にしておけば DevTools の LiveReload と連携して自動リロードされる。
  - 代替: フロントエンドに Browsersync や webpack-dev-server を導入する（今回は過剰なので不要）。

5) VS Code 固有の注意点
- VS Code の Java 自動ビルドは環境依存。拡張機能（Language Support for Java）に自動ビルド機能があるが、確実性を高めるために Gradle の継続ビルドを同時に走らせることを推奨。
- Spring Boot Extension Pack / Spring Boot Tools をインストールすると、Spring Boot アプリケーションの起動管理やデバッグが便利になる（ホットデプロイ自体は DevTools 側で行う）。

実装手順（提案）
1. `saikyoapps/saikyoapps/build.gradle` に DevTools を追加:
   - dependencies に: `developmentOnly 'org.springframework.boot:spring-boot-devtools'`
2. `saikyoapps/saikyoapps/src/main/resources/application.properties` を作成／編集し以下を追加:
   - spring.thymeleaf.cache=false
   - spring.web.resources.cache.period=0
   - spring.devtools.restart.enabled=true
   - spring.devtools.livereload.enabled=true
3. 開発時の起動手順（2つのターミナルを使う）:
   - ターミナル A: `./gradlew bootRun` を実行してアプリを起動
   - ターミナル B: `./gradlew -t classes` を実行して継続コンパイルを監視
   - ブラウザに LiveReload 拡張を入れ有効化しておく（または手動でリロード）
4. 動作確認手順:
   - テンプレート（`src/main/resources/templates/index.html`）を編集して保存 → ブラウザが自動でリロードされる（または即時で反映される）
   - 静的リソース（`src/main/resources/static/js/*`）を編集して保存 → LiveReload によりブラウザがリロードされる
   - Java ソース (`src/main/java/...`) を編集して保存 → ターミナル B によりコンパイルが実行され、DevTools が検知してアプリが自動再起動される（再起動ログがターミナルに出る）。

確認基準（DoD）
- 追加変更: `build.gradle` と `application.properties` を変更済みであること
- 起動方法: `./gradlew bootRun` を実行したまま、別ターミナルで `./gradlew -t classes` を実行していること
- 検証結果:
  - テンプレートを編集するとブラウザが自動更新される、または保存後に即時反映されること
  - Java ソースを編集すると自動でコンパイルされアプリが再起動されること（再起動ログ確認）

留意点
- DevTools の自動再起動はクラスローダを使った高速な再起動だが完全なプロセス再起動ではない。長期実行テストやメモリリーク確認などは通常起動で行う。
- DevTools は本番に含めないこと。`developmentOnly` での定義や本番ビルド時の除外を確認する。

参考
- Spring Boot DevTools: https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#using.devtools
- Thymeleaf: spring.thymeleaf.cache
- Spring Boot static resources: spring.web.resources.cache.period

---
作成者: GitHub Copilot
