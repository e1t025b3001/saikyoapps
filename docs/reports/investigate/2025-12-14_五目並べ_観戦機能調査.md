# 五目並べ（Gomoku）観戦機能調査

作成日: 2025-12-14
作成者: GitHub Copilot

目的

- 現状の五目並べ（Gomoku）に「観戦（spectate）」機能を追加するための調査。要求は、既存の対戦を他のログインユーザが一覧から選択してリアルタイムに観戦できること。

調査対象ソース（現状確認）

- サーバ側コントローラ: `src/main/java/team1/saikyoapps/controller/GomokuController.java`
  - 重要な既存API: `GET /gomoku/{gameId}`（ゲーム状態取得）、`POST /gomoku/{gameId}/move`（落子）、`POST /gomoku/{gameId}/forfeit`（投降）
  - 実装の特徴: 対局終了時に gomoku_game や gomoku_move を削除する処理がある（勝利時や投降時に moves を削除、場合によっては gomoku_game を削除/board を null にする）。

- DBアクセス: `src/main/java/team1/saikyoapps/model/GomokuGameMapper.java`、`GomokuMoveMapper.java`
  - `gomoku_game` テーブル: game_id, player_black, player_white, board_state, turn, status
  - `gomoku_move` テーブル: game_id ごとの移動履歴を保持するが、サーバ側で削除される処理あり

- フロントエンド: `src/main/resources/templates/gomoku.html`（および build/ 以下にビルド版）
  - クライアントはページロード時に `GET /gomoku/{gameId}` を1秒ごとにポーリングして状態を取得している（pollingベース）。
  - クライアント側で `myColor` が無い場合（観戦者と同様の状態）に特別な観戦処理はないが、クリックハンドラは "myColor が無い/自分のターンでない" をチェックして落子を防いでいる。
  - surrender（投降）ボタンなどプレイヤー用UIが存在する。

既存の問題点（観戦を実装する上での課題）

1. 対局終了時に盤面/移動履歴を削除するため、観戦中にゲームが終了すると履歴が消える/観戦できない可能性がある。
2. 現状の `GET /gomoku/{gameId}` は認証済ユーザに対して `myColor` を返す実装になっているが、観戦者向けに "観戦モード" の明示（例: role: spectator）がない。
3. ロビー側に対して「観戦」一覧を返すAPIが存在しない（現在の構成ではマッチング周りのテーブルはあるが観戦一覧用APIは未実装）。
4. 現状はポーリングで実装されているため、スケーリング／遅延／負荷の懸念がある（観戦者が多い場合）。
5. フロント側UIは観戦者向けの表示（観戦モード表示・操作不可化）や一覧から選択するUIが未実装。

要件（ユーザ指定）

- 2アカウントで対戦を開始し、別のアカウントで「観戦」をクリックすると、対戦中のゲーム一覧（GAME_ID と対戦プレイヤー名の組）を表示。
- 一覧から1つ選択すると、そのゲームの現在の進行状態からリアルタイムで観戦できる。
- 観戦は読み取り専用。観戦者が落子等を送れるべきではない。

推奨設計（高レベル）

1. API追加・修正
   - 新規: `GET /gomoku/spectate/list`
     - 機能: 対局中（status = 'playing'）のゲームを一覧で返す。
     - レスポンス項目例: [{ gameId, playerBlack, playerWhite, startedAt? }]
     - 認証: ログイン必須（匿名観戦を許すなら匿名対応を検討）

   - 既存: `GET /gomoku/{gameId}` を観戦でも利用可能にする（現在も利用可能）。
     - 変更点: 既に board/turn/finished を返す実装があるため、観戦者向けに `myColor` が null であることを明示的に扱う。レスポンスに `mode: 'player'|'spectator'` を追加してもよい。

   - 既存: `POST /gomoku/{gameId}/move` はサーバ側でプレイヤー以外（観戦者）からの呼び出しを拒否するチェックがあるためそのままでよい（念のため観戦者からのアクセスは403にする）。

2. DB運用方針
   - 対局中（status = 'playing'）の間は `gomoku_game.board_state` と `gomoku_move` の保存を維持する。
   - 対局終了時の現在の実装は勝敗/投降時に moves を削除しているようなので、観戦機能のために下記のどちらかを推奨:
     - A: 盤面と moves を保持したまま `status` を `finished` に変更し、参照可能にする（推奨）。
     - B: 現行ロジックを残す場合は「観戦中は削除処理を抑制」する制御を追加する（実装複雑）。
   - 履歴保存が必要なら、`match_history` に加えて `archive` フラグや `archived_at` を追加する設計も検討。

3. フロントエンド変更
   - ロビー画面に「観戦」ボタンを追加し、クリックすると `GET /gomoku/spectate/list` を呼んで一覧表示するUIを作る。ファイル例: `templates/matching.html` または新規 `spectate_list.html`。
   - 観戦者がゲームを開くと既存の `gomoku.html` を gameId パラメータ付きで開く（現状 `pageGame` に gameId を入れている実装がある）。
   - `gomoku.html` 側で観戦者判定を行い（server から `myColor` が返らない／`mode: 'spectator'`）、以下を行う:
     - クリックによる落子送信を無効化（既に実装されているがUI上もボタンや説明を表示）。
     - surrender（投降）ボタンや参加用UIを非表示にする。
     - 観戦モード表示（例: ページ上部に「観戦中」ラベル、対戦プレイヤー名表示）を追加。

4. リアルタイム性の選択
   - 現状は1秒ポーリング。観戦者が増えると負荷が増す。
   - すぐに実装するならポーリングを流用（簡単）。ただし負荷対策として:
     - polling interval を観戦時のみ長めにする（例 1s -> 2s）、または接続数に応じて伸ばす。
     - ETag/If-Modified-Since のような差分取得を検討（現状 JSON を返しているため実装コストあり）。
   - 将来的には WebSocket を導入してサーバから差分 push する方が望ましい（変更箇所: 新規 WebSocketエンドポイント／フロントJSの書き換え）。

5. セキュリティ・認可
   - 観戦はログインユーザのみ許可することを推奨（匿名観戦は要要件確認）。
   - `POST /gomoku/{gameId}/move` は観戦者からの呼び出しを明確に403で拒否する（既存チェックを確認）。
   - 観戦一覧に表示するゲームは公開に問題がないか検討（プライバシー）。

影響範囲（変更見込みファイル）

- サーバ
  - `src/main/java/team1/saikyoapps/controller/GomokuController.java`（新 API 追加、getGame のレスポンス拡張、終了時の削除ポリシー修正）
  - `src/main/java/team1/saikyoapps/model/GomokuGameMapper.java`（必要に応じて SELECT を追加）
  - `src/main/java/team1/saikyoapps/model/GomokuMoveMapper.java`（削除ロジックの見直し）

- フロント
  - `src/main/resources/templates/gomoku.html`（観戦モード表示制御）
  - ロビー系テンプレート（`matching.html` `index.html` など）に観戦一覧用UIを追加
  - 必要に応じて新規 JS ファイル（例: `static/js/gomoku_spectate.js`）を追加

- ドキュメント
  - `docs/specs.md` に観戦機能の仕様追記
  - `docs/personal_tasks/tasks_YYYY_MM_DD_...md` に実装タスク登録

推奨実装手順（段階的）

1. 調査（済）
2. API 設計確定: `GET /gomoku/spectate/list` の仕様、`GET /gomoku/{gameId}` レスポンスに `mode` フィールド付与するかどうかを決定
3. DB 挙動方針決定: 対局終了時の moves/board 削除を止めるか、観戦用に保持する期間を決める
4. サーバ実装: list API を追加、getGame の挙動を確認・修正、終了処理の削除抑制
5. フロント実装: ロビーの観戦一覧 UI、gomoku.html の観戦モード表示と操作無効化
6. テスト: ローカルで2アカウントで対局、別アカウントで観戦、対局の進行を確認
7. 負荷検討: polling の間隔調整、必要なら WebSocket に移行する計画

設計上の注意点・リスク

- 現行で勝利時に gomoku_game を削除する処理があるため、観戦者がいる最中に game が削除されると観戦が切断される。対局終了時の削除ロジックは慎重に扱う必要がある。
- 観戦者が多数いる場合、1秒ポーリングだとサーバ負荷が高くなる。負荷対策は早めに検討推奨。
- セキュリティ上、非プレイヤーからの落子リクエストを確実にブロックすること。

簡易API仕様（例）

- GET /gomoku/spectate/list
  - 認証: 必須
  - レスポンス 200: [{ "gameId": "...", "playerBlack": "userA", "playerWhite": "userB", "startedAt": "..." }, ...]

- GET /gomoku/{gameId}
  - 認証: 任意（未ログインは観戦不可なら認証必須）
  - 既存レスポンスに `mode` を追加する場合の例:
    {
      "board": [[...]],
      "turn": "black",
      "finished": false,
      "myColor": null,
      "mode": "spectator",
      "playerBlack": "userA",
      "playerWhite": "userB"
    }

次のアクション（提案）

1. この調査内容を確認していただき、実装方針（DBで履歴を保持するか／削除するか、ポーリング継続か WebSocket に移行するか）を決めてください。
2. 実装フェーズを開始する場合、私に「実装」を指示してください。実装前に必ず main ブランチにいることを確認し、新しいブランチ名（例: `feat/gomoku-spectate`）を指定してください。

参考（既存ファイル）

- `src/main/resources/templates/gomoku.html`
- `src/main/java/team1/saikyoapps/controller/GomokuController.java`
- `src/main/java/team1/saikyoapps/model/GomokuGameMapper.java`
- `src/main/java/team1/saikyoapps/model/GomokuMoveMapper.java`
- `docs/reports/investigate/2025-12-07_五木並べ實作調查.md`

---

作業報告（本ファイル作成後のユーザが取れる行動）

- 本調査を確認し、観戦機能の実装方針（履歴保持の有無、ポーリング継続／WebSocket移行の可否）を決定してください。
- 実装を開始する場合は「実装」を指示してください。実装手順と変更ファイルを段階的に提示しながら進めます。

以上。
