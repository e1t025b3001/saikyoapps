# マルバツ（Marubatsu）観戦機能実装調査

実施日: 2026-01-06

目的: 五目並べ（Gomoku）で既に実装されている観戦方式を参考に、マルバツ（Marubatsu）へ同様の観戦機能を実装するための調査。

概要（結論）
- Gomoku の実装では、観戦用一覧ページ（`/gomoku/spectate`）と一覧取得 API（`GET /gomoku/spectate/list`）を追加し、既存のゲーム表示ページ（`/gomoku?matchId=...&mode=spectate`）を流用して観戦表示を実現している。
- 同じ方式を Marubatsu に適用することで、最小限の差分で観戦機能を実装できる。

既存実装（参考ファイル）
- サーバ側
  - `saikyoapps/src/main/java/team1/saikyoapps/controller/GomokuController.java`
    - `@GetMapping("/spectate/list")` により対局中ゲーム一覧を返す。
    - `@GetMapping("/{gameId}")` のレスポンスに `mode`、`playerBlack` / `playerWhite`（あるいは myColor）を含めることで観戦/プレイヤーモードを区別している。
  - `saikyoapps/src/main/java/team1/saikyoapps/controller/MatchingController.java`
    - `@GetMapping("/gomoku/spectate")` でテンプレート `gomoku_spectate.html` を返す。
- クライアント側テンプレート
  - `saikyoapps/src/main/resources/templates/gomoku_spectate.html`
    - `/gomoku/spectate/list` を fetch し、一覧を表示。行の「観戦」ボタンで `/gomoku?matchId=...&mode=spectate` に遷移する。
  - `saikyoapps/src/main/resources/templates/gomoku.html`
    - `mode=spectate` の場合、投降ボタンを非表示にする等、観戦用の UI 挙動に対応している。

必要な変更（Marubatsu へ適用する最小構成）
1. サーバ側 API 追加 / 修正
   - `MarubatsuController` に `@GetMapping("/spectate/list")` を追加し、対局中（status='playing'）の marubatsu_game を返す。実装は Gomoku の `listSpectateGames` を参考にする。
   - `MarubatsuController` の `GET /{gameId}` が既に存在する場合、レスポンスに `playerX`/`playerO`（または `playerBlack`/`playerWhite` に合わせる）と `mode` (`player` 或いは `spectator`) を含めるよう確認・修正する。
   - `POST /{gameId}/move` は既に非プレイヤーからの操作を 403 で拒否しているが、観戦モードの判定ロジックを `GET /{gameId}` と整合させること。
2. テンプレート追加
   - `saikyoapps/src/main/resources/templates/marubatsu_spectate.html` を `gomoku_spectate.html` を参考に作成する。
   - 観戦ボタン押下で `/marubatsu?matchId={GAME_ID}&mode=spectate` に遷移するようにする。
3. ルーティング（ビュー）追加
   - `MatchingController` に `@GetMapping("/marubatsu/spectate")` を追加し、テンプレートを返す（`model.addAttribute("game","marubatsu")` 等）。Gomoku の実装を参照。
4. i18n / UI 文言
   - 既存の spectate 関連キーは Gomoku 用に整備されている。必要に応じて `messages_*.properties` に marubatsu 固有の文言追加は不要（汎用キーを流用可能）が、文言差異が必要なら追加する。

影響範囲（ファイル一覧）
- 変更/追加予定
  - サーバ: `saikyoapps/src/main/java/team1/saikyoapps/controller/MarubatsuController.java`（spectate list 追加、GET 修正）
  - サーバ: `saikyoapps/src/main/java/team1/saikyoapps/controller/MatchingController.java`（/marubatsu/spectate 追加）
  - テンプレート: `saikyoapps/src/main/resources/templates/marubatsu_spectate.html`（新規）
  - 既存テンプレート: `saikyoapps/src/main/resources/templates/marubatsu.html`（観戦時の UI を再利用できるか確認）
  - （必要に応じて）`src/main/resources/i18n/messages_*.properties`

動作確認手順（DoD）
1. ローカル起動: gradle bootRun でアプリを起動する。
2. ブラウザで `/marubatsu/spectate` にアクセスし、対局中のゲーム一覧が表示されることを確認する（ログイン必須の設定ならログインする）。
3. 一覧の「観戦」ボタンをクリックして `/marubatsu?matchId={GAME_ID}&mode=spectate` に遷移し、観戦 UI が表示されることを確認する。
4. 観戦者から `POST /marubatsu/{gameId}/move` を送信した場合、サーバが 403 を返すことを確認する。
5. 対局終了後も最終盤面/勝敗が観戦 UI で表示されることを確認する。

実装にあたっての注意点 / 推奨事項
- Gomoku の実装をできるだけ流用し、命名（playerX/playerO と playerBlack/playerWhite の差）に注意する。Marubatsu では既に `MarubatsuGame` に playerX/playerO が使われているため、テンプレート側でのフィールド名を整合させること。
- セキュリティ: 観戦は認証ユーザのみに制限する方針なら、一覧 API に認証チェック（401）を置く。Gomoku は認証必須としているためそれに追従するのが安全。
- DB 削除方針: Gomoku/Marubatsu 共に終了後の盤面/move を即削除する動作があるが、観戦のため削除を遅らせる（短い猶予を設ける）既存の実装パターンがある。Marubatsu 実装と挙動を合わせる。

参考実装箇所（コピー元）
- `saikyoapps/src/main/java/team1/saikyoapps/controller/GomokuController.java` の `listSpectateGames` と `GET /{gameId}` の返却形式
- `saikyoapps/src/main/resources/templates/gomoku_spectate.html`
- `saikyoapps/src/main/java/team1/saikyoapps/controller/MatchingController.java` の `@GetMapping("/gomoku/spectate")`

次のアクション（提案）
- 実装フェーズへ移行してよければ指示してください。実装前にブランチ切替（main から feat/…）を行い、段階的にコミットします。

以上。
