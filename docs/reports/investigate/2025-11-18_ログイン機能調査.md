# 調査レポート: ログイン機能の全体フロー（2025-11-18）

## 前提（ワークスペースの現状）
- Spring Boot プロジェクト（`team1/saikyoapps`）。
  - ビルドファイル: `saikyoapps/saikyoapps/build.gradle`（`org.springframework.boot:spring-boot-starter-security` が既に含まれている）
  - エントリ: `team1.saikyoapps.SaikyoappsApplication`（`saikyoapps/src/main/java/team1/saikyoapps/SaikyoappsApplication.java`）
  - 設定: `saikyoapps/src/main/resources/application.properties`
- 利用可能なライブラリ候補: Spring Security、Thymeleaf + `thymeleaf-extras-springsecurity6`。
- 本調査では、igakilab/springboot_samples のように「事前にリポジトリやドキュメントで配布する ID/パスワード」を用いた in-memory 認証方式を採用する前提でまとめる。
  - 補足: プロジェクトには MyBatis 等の依存が残るが、今回の認証実装は DB を用いない（in-memory）方式を想定する。

## 目的
- Spring Security を使ったログイン（フォーム認証）を、あらかじめ設定したユーザ情報（ID/Pass）を配布する方式で実装するための全体フローと必要コンポーネントを整理する。
- 実装前に押さえるべき注意点と検証方法を明確化する。

## 必要な主要コンポーネント（概念レベル）
1. セキュリティ設定クラス
   - Http セキュリティの設定（フォームログイン、保護対象 URL、静的リソースの除外など）
2. 事前設定ユーザの管理（in-memory）
   - `InMemoryUserDetailsManager` を使ってアプリ起動時にユーザを登録するか、`UserDetailsService` を実装してハードコードされたユーザ情報を返す
   - サンプルユーザはソース内で定義する（テスト用／配布用ドキュメントに記載）
3. パスワードハッシュ化
   - 本番では `PasswordEncoder`（例: `BCryptPasswordEncoder`）でハッシュ化して管理することを推奨
   - 開発/演習用に限り `{noop}` を使った平文認証を利用する場合は、リポジトリに平文を残さない等の注意が必要
4. ログインフォーム（Thymeleaf テンプレート）
   - `username`, `password` フィールド、CSRF トークン埋め込み
5. ログアウト処理（`/logout` の設定）
6. ロール（`ROLE_USER` など）管理（in-memory で付与）
7. テスト（`spring-security-test` を使った統合／単体テスト）

## 実装の大まかな流れ（ステップ）
1. 方針決定
   - 今回は「事前配布 ID/Pass（in-memory）」方式を採用することを確定する
   - 配布方法（README に記載、組織運営側でメール配布、など）を決める
2. サンプルユーザを定義する
   - 例: `player1 / p@ss1`, `player2 / p@ss2`（役割: `ROLE_USER`）
   - 推奨: 実運用でなければハッシュ化して `BCrypt` を使用し、ハッシュ値をリポジトリに置く場合は取り扱い注意を明記する
3. `SecurityConfiguration` 作成
   - `@Configuration` クラスで `SecurityFilterChain` と `InMemoryUserDetailsManager`（または `UserDetailsService`）を定義
   - ログインページ、デフォルト遷移、失敗時遷移、静的リソースの許可を設定
   - `PasswordEncoder` を Bean として登録
4. ログインページ（Thymeleaf）作成
   - `templates/login.html` にフォームを作成し CSRF トークンを埋め込む
5. 認証情報の配布方法準備
   - `docs/` 以下に `credentials.md` を作成して配布用ユーザ一覧を記載する、または運営側で配布する
   - 重要: repo に平文パスワードをコミットしない方針なら、代替として初回ログイン時にパスワード変更を促す仕組みを検討
6. テスト作成
   - `spring-security-test` を使い、設定したユーザでのログイン成功/失敗テストを作成
7. 動作確認
   - `./gradlew bootRun` -> ブラウザでログインを確認。テスト実行

## サンプル: SecurityConfiguration の方針（概念）
- InMemoryUserDetailsManager を Bean 定義し、起動時にサンプルユーザを追加する。
- 例（概念）:
  - player1 / p@ss1 (ROLE_USER)
  - player2 / p@ss2 (ROLE_USER)
- 本番や公開リポジトリではパスワードの取り扱いに注意し、可能な限りハッシュ化した情報のみを扱う。

## 配布手順（運用上の提案）
- 小規模なコンペや演習用途であれば `docs/credentials.md` に配布ユーザ一覧をまとめる。
- 配布前にパスワードをプレーンテキストで共有する場合は、期限付き利用やサンプル専用アカウントであることを明記し、不要になったら無効化する運用を設定する。
- 代替案: プレイヤーごとに一意なパスワードを発行し、各自にメールで通知する（運用負荷は高い）。

## 注意点・セキュリティ考慮（in-memory 前提）
- 開発/演習用であっても、パスワードは可能ならハッシュ化して保管すること（`BCrypt` 推奨）。
- リポジトリに平文パスワードを残すことは避ける。ドキュメントで例示する場合はダミーのパスワードにするか、配布手段を別にする。
- CSRF 保護および静的リソースのアクセス許可設定を適切に行う。
- ログイン成功後はデフォルト遷移先（例: `/` または `/game`）を明確にする。
- 演習後に同じ静的アカウントを使い続けない運用（無効化、パスワード変更）を検討する。

## テスト方針（最低限）
- 事前設定ユーザによるログイン成功ケース
- 無効パスワードでのログイン失敗ケース
- 保護された URL に未認証でアクセス時にログインページへリダイレクト
- ロールに基づくアクセス制御の検証（必要であれば）

## 参考（実装例参照）
- igakilab/springboot_samples（参考実装集）
  - https://github.com/igakilab/springboot_samples

## 推奨する次のアクション（計画フェーズへ）
1. 配布するユーザ一覧（ID/Pass）を決定する
2. `docs/tasks.md` に実装タスクを記載（小さな単位に分割）
3. 実装ブランチの命名や運用（`main` から `feat/login` を作成）を決定する
4. 実装で必要なファイル一覧（`SecurityConfig`, `templates/login.html`, `docs/credentials.md`, `tests`）を確定する

---
作業者: GitHub Copilot
