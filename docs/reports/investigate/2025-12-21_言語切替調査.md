# 2025-12-21 言語切替（日本語/繁体字）機能調査

## 目的
ログイン後にホーム画面で日本語（ja）と中国語（繁体字、zh_TW）をトグル可能にし、現在の設定と異なる選択肢を選んだ場合に「保存」ボタンを表示して押下で保存する。今回はタイトル画面（ページタイトル／ヘッダ）の翻訳切替のみ実装対象とする。翻訳文は拡張しやすい構造で管理する。

## 要件（高レベル）
- ログインユーザごとに言語設定を保持（既に `i18n_config` テーブルに保存している）。
- ホーム画面にトグルボタンを表示し、現在の言語と異なる場合のみ「保存」ボタンを表示する。
- 保存すると DB の `i18n_config` を insert/update し、以後の画面でタイトルが選択言語で表示される。
- 翻訳は拡張が容易な形式で管理（新言語追加が簡単）。
- 今回は画面ラベルはタイトルのみ変更する。

## 現状の問題点（今回発見したこと）
- MyBatis Mapper の SQL 文に構文エラーがあった（以前のエラー）。現在は mapper が `login_user` カラムを使うよう修正済みだが、コントローラからの呼び出しやモデルのフィールド名の整合性、null 安全性を確保する必要がある。
- HomeController で `findByUserName(...).getLocale()` のようにチェーンしている箇所があると、DB にレコードがない場合に NullPointerException になる。

## 実装方針（選択肢と推奨）
以下の 3 通りを検討した。

1) Spring の MessageSource（プロパティ資源ファイル）を使う（推奨）
- メッセージファイル例: `src/main/resources/i18n/messages_ja.properties`, `messages_zh_TW.properties`。
- 設定: `application.properties` に `spring.messages.basename=i18n/messages` と `spring.messages.encoding=UTF-8` を設定。
- テンプレート(Thymeleaf)での参照: `th:text="#{title}"`。
- 利点: Spring 標準で運用しやすく、新言語追加が容易（プロパティファイルを追加）。高速で依存が少ない。

2) DB に翻訳を入れて動的に読み込む（DB ベース MessageSource）
- 翻訳編集をアプリ上で行いたい場合や、管理画面から即時反映させたい場合に有効。
- 実装コストと複雑さが増す（キャッシュなども検討）。

3) JSON/YAML ファイルで管理
- 構造化された翻訳を好む場合に有効。ただし Spring 標準の MessageSource と組み合わせるためのラッパ実装が必要。

推奨は (1)。今回はタイトルのみなので MessageSource を使い、ユーザの選択は DB に保存してセッションまたは LocaleResolver 経由で Locale を反映するのが最も簡単で拡張性が高い。

## 推奨実装手順（段階）
1. リソース追加
   - `src/main/resources/i18n/messages_ja.properties`
     - 例: `title=ようこそ {0} さん`
   - `src/main/resources/i18n/messages_zh_TW.properties`
     - 例: `title=歡迎 {0} 同學`

2. MessageSource 設定
   - `application.properties` に以下を追加
     - `spring.messages.basename=i18n/messages`
     - `spring.messages.encoding=UTF-8`

3. Locale 解決の仕組み
   - セッションベースの `SessionLocaleResolver` を導入し、ログイン直後および言語保存時にセッションに Locale をセットする方法。
   - 代替: ユーザごとの永続設定（`i18n_config`）を優先して読み、リクエストごとに `LocaleContextHolder.setLocale(locale)` を呼ぶハンドラ（Interceptor）を用意する。

4. DB 保存ロジック（既存テーブル `i18n_config`）
   - Controller の `setI18n` メソッド
     - 認証済みユーザ名を取得 -> `i18nConfigMapper.findByUserName(loginUser)` を呼ぶ
     - null の場合は `insert(loginUser, locale)`、存在する場合は `updateLocaleByUserName(loginUser, locale)`
     - その後セッションに Locale を保存（または LocaleResolver を更新）して即時反映
   - Mapper インタフェースは既に `login_user` を参照するようになっていることを確認
   - Model クラス `I18nConfig` のフィールド名を `loginUser` に合わせるか、Mapper の `SELECT` で `AS loginUser` のように alias を合わせる

5. テンプレート側
   - `templates/index.html` のタイトル部分を `th:text` で MessageSource に委譲
     - 例: `<h1 th:text="#{title}">ようこそ</h1>`
   - ユーザ名挿入が必要なら `#{title(${username})}` やコントローラで `messageSource.getMessage("title", new Object[]{userName}, locale)` を用いて model に入れる

6. エラーハンドリングと安全対策
   - `findByUserName` の戻り値に対しては必ず null チェック
   - Mapper の SQL 文は予約語やカラム名に注意（例: `user` を避け `login_user` を使う）
   - MyBatis の `@Param` 名と SQL 内のバインド名を一致させる

## 変更・追加が必要な主なファイル一覧（作業対象候補）
- 既存（修正）
  - `src/main/java/team1/saikyoapps/controller/HomeController.java` （言語保存処理とセッション/locale 設定）
  - `src/main/java/team1/saikyoapps/model/I18nConfigMappaer.java`（insert/update/select の引数および SQL）
  - `src/main/java/team1/saikyoapps/model/I18nConfig.java`（フィールド名の整合）
  - `src/main/resources/schema.sql`（既に修正済み: login_user カラムの定義）
  - `src/main/resources/templates/index.html`（タイトルを MessageSource 化）

- 新規（追加推奨）
  - `src/main/resources/i18n/messages_ja.properties`
  - `src/main/resources/i18n/messages_zh_TW.properties`
  - `src/main/java/team1/saikyoapps/config/LocaleConfig.java`（LocaleResolver の Bean 定義、および必要なら Interceptor 登録）

## テスト手順 / DoD（Definition of Done）
1. ブランチを作成して実装を行う（例: `feat/i18n-ja-zh-TW`）。
2. `gradle bootRun` でアプリを起動する。
3. ブラウザで `http://localhost:8080/` にアクセスし、ログイン（例: user1 / p@ss）する。
4. ホーム画面で現在の言語表示を確認する（例: 「日本語」選択時は日本語タイトル）。
5. 別の言語を選ぶと「保存」ボタンが表示されることを確認する。
6. 「保存」を押下すると HTTP POST がコントローラに到達し、DB の `i18n_config` が insert または update されることを確認する。
7. 保存後にページのタイトルが選択した言語に変わっていることを確認する。

DoD の成功条件例:
- `i18n_config` テーブルに `login_user` と `locale` のレコードが正しく追加/更新される
- index ページのタイトルが `messages_{locale}.properties` の `title` 値に従って表示される

## 参考 URL
- Spring Boot 公式（メッセージ・国際化）: https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#howto-internationalization
- Thymeleaf: https://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html#message-externalization
- MyBatis 注釈方式: https://mybatis.org/mybatis-3/getting-started.html#mapper-annotations

## 次のアクション（提案）
1. この調査結果で問題なければ、実装フェーズに移行します（実装前に必ず main ブランチ上で新規ブランチを切ってください）。
2. 実装フェーズでは最初に MessageSource ファイル（`messages_*.properties`）を追加し、`HomeController` に保存処理の null 安全化とセッションへの locale 設定を追加します。
3. もし DB ベースで翻訳を管理したい場合は、その要件と管理 UI の有無を教えてください（別途調査します）。

---
作成者: GitHub Copilot
