<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <title th:text="#{match.success.title} ?: 'マッチング成功'">マッチング成功</title>
  <link rel="stylesheet" th:href="@{/css/main.css}" />
</head>

<body data-page="match_success">
  <div class="container section-center">
    <h1 th:text="#{match.success} ?: 'マッチング成功！まもなくゲーム画面に移動します。'">マッチング成功！まもなくゲーム画面に移動します。</h1>

    <!-- hidden inputs を使ってサーバ側からの値を JS で安全に取得する -->
    <input type="hidden" id="gameInput" th:value="${game}" />
    <input type="hidden" id="matchIdInput" th:value="${matchId}" />

    <div class="card">
      <a th:href="@{/}" class="btn" th:text="#{match.return.selectgame} ?: 'ゲーム選択に戻る'">ゲーム選択に戻る</a>
    </div>
  </div>

  <script>
    (function () {
      // hidden input から安全に値を取得
      const gameEl = document.getElementById('gameInput');
      const matchEl = document.getElementById('matchIdInput');
      const game = gameEl ? gameEl.value : 'marubatsu';
      let matchId = matchEl ? matchEl.value : null;

      // 如果沒有 matchId，嘗試透過 matching/status 取得一次 gameId，再 redirect
      async function resolveAndRedirect() {
        if (!matchId) {
          try {
            const resp = await fetch('/matching/status?game=' + encodeURIComponent(game), { cache: 'no-store', credentials: 'include' });
            if (resp.ok) {
              const j = await resp.json();
              if (j && j.status === 'playing' && j.gameId) {
                matchId = j.gameId;
              }
            }
          } catch (e) {
            console.warn('Failed to fetch matching/status for redirect', e);
          }
        }

        let url = '/' + encodeURIComponent(game);
        if (matchId) url += '?matchId=' + encodeURIComponent(matchId);
        window.location.href = url;
      }

      setTimeout(resolveAndRedirect, 1200);
    })();
  </script>

</body>

</html>
