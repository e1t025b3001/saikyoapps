<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <title>マッチング成功</title>
</head>

<body>
  <h1>マッチング成功！まもなくゲーム画面に移動します。</h1>
  <p th:text="'ゲーム: ' + ${game}">ゲーム</p>

  <!-- hidden inputs を使ってサーバ側からの値を JS で安全に取得する -->
  <input type="hidden" id="gameInput" th:value="${game}" />
  <input type="hidden" id="matchIdInput" th:value="${matchId}" />

  <script>
    (function () {
      // hidden input から安全に値を取得
      const gameEl = document.getElementById('gameInput');
      const matchEl = document.getElementById('matchIdInput');
      const game = gameEl ? gameEl.value : 'marubatsu';
      let matchId = matchEl ? matchEl.value : null;

      // 如果沒有 matchId，嘗試透過 matching/status 取得一次 gameId，再 redirect
      async function resolveAndRedirect() {
        if (!matchId) {
          try {
            const resp = await fetch('/matching/status?game=' + encodeURIComponent(game), { cache: 'no-store', credentials: 'include' });
            if (resp.ok) {
              const j = await resp.json();
              if (j && j.status === 'playing' && j.gameId) {
                matchId = j.gameId;
              }
            }
          } catch (e) {
            console.warn('Failed to fetch matching/status for redirect', e);
          }
        }

        let url = '/' + encodeURIComponent(game);
        if (matchId) url += '?matchId=' + encodeURIComponent(matchId);
        window.location.href = url;
      }

      setTimeout(resolveAndRedirect, 1200);
    })();
  </script>

  <a th:href="@{/}">ゲーム選択に戻る</a>
</body>

</html>
