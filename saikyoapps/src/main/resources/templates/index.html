<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <title th:text="${i18n_title}"></title>
  <link rel="stylesheet" th:href="@{/css/main.css}" />
  <link rel="stylesheet" th:href="@{/css/index.css}" />
</head>

<body data-page="index">
  <!-- ゲーム選択セクションを追加 -->
  <section class="container section-center">
    <h2 th:text="#{home.games.select}">ゲームを選択してください</h2>
    <div id="game-buttons">
      <a th:href="@{/matching(game='marubatsu')}" class="game-btn" data-game="marubatsu"
        th:text="#{home.games.marubatu}">マルバツ</a>
      <a th:href="@{/matching(game='gomoku')}" class="game-btn" data-game="gomoku"
        th:text="#{home.games.gomoku}">五目並べ</a>
      <a th:href="@{/matching(game='othello')}" class="game-btn" data-game="othello"
        th:text="#{home.games.Othello}">オセロ</a>
      <a th:href="@{/matching(game='shinkeisuijaku')}" class="game-btn" data-game="shinkeisuijaku"
        th:text="#{home.games.memory-game}">神経衰弱</a>
      <a th:href="@{/matching(game='uno')}" class="game-btn" data-game="uno" th:text="#{home.games.uno}">UNO</a>
      <a th:href="@{/matching(game='darour')}" class="game-btn" data-game="darour"
        th:text="#{home.games.darour}">大老二</a>
    </div>

    <div id="game-actions" style="margin-top:16px; display:flex; gap:8px; justify-content:center;">
      <!-- マッチング開始 -->
      <button id="start-matching-btn" class="btn primary" th:text="#{home.match.start}">マッチング開始</button>
      <!-- 観戦ボタン（ゲーム選択に応じて表示・ラベル切替） -->
      <button id="spectate-btn" type="button" style="display:none;margin-left:8px;" class="btn primary">観戦</button>
    </div>
    </div>

    <script th:inline="javascript">
      (function () {
        const gameButtons = document.querySelectorAll('.game-btn');
        const startBtn = document.getElementById('start-matching-btn');
        const spectateBtn = document.getElementById('spectate-btn');
        let selectedGame = null;

        // どのゲームが観戦をサポートするか
        const spectateSupportedGames = ['gomoku', 'marubatsu'];
        const spectateLabels = {
          gomoku: /*[[#{home.spectate.gomoku}]]*/ '観戦（五目並べ）',
          marubatsu: /*[[#{home.spectate.marubatsu}]]*/ '観戦（マルバツ）'
        };

        function clearSelectionStyles() {
          gameButtons.forEach(b => {
            b.style.backgroundColor = '';
            b.style.border = '';
          });
        }

        function updateSpectateButtonVisibility() {
          if (!spectateBtn) return;
          if (spectateSupportedGames.includes(selectedGame)) {
            spectateBtn.style.display = '';
            spectateBtn.textContent = spectateLabels[selectedGame] || /*[[#{home.spectate.default}]]*/ '観戦';
          } else {
            spectateBtn.style.display = 'none';
          }
        }

        gameButtons.forEach(btn => {
          btn.addEventListener('click', function (e) {
            // prevent immediate navigation so user can select and then choose action
            e.preventDefault();
            selectedGame = btn.getAttribute('data-game');
            clearSelectionStyles();
            btn.style.backgroundColor = '#cce5ff';
            btn.style.border = '1px solid #004085';
            updateSpectateButtonVisibility();
          });
        });

        if (startBtn) {
          startBtn.addEventListener('click', function () {
            if (!selectedGame) {
              alert(document.documentElement.getAttribute('data-alert-select') || 'Please select a game.');
              return;
            }
            const url = '/matching?game=' + encodeURIComponent(selectedGame);
            window.location.href = url;
          });
        }

        if (spectateBtn) {
          spectateBtn.addEventListener('click', function () {
            if (!selectedGame) { alert(document.documentElement.getAttribute('data-alert-select-spectate') || 'Please select a game first.'); return; }
            if (!spectateSupportedGames.includes(selectedGame)) { alert(document.documentElement.getAttribute('data-alert-spectate-not-supported') || 'This game does not support spectate.'); return; }
            const url = '/' + encodeURIComponent(selectedGame) + '/spectate';
            window.location.href = url;
          });
        }

        // 初期表示
        updateSpectateButtonVisibility();
      })();
    </script>

    <form th:action="@{/logout}" method="post">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
      <button type="submit" th:text="#{home.match.logout}">ログアウト</button>
    </form>

    <form th:action="@{/i18n}" method="post" id="i18n-form">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
      <input id="radio1" type="radio" name="i18n" value="ja" th:checked="${i18n == 'ja'}" />
      <label for="radio1">日本語</label>
      <input id="radio2" type="radio" name="i18n" value="zh_TW" th:checked="${i18n == 'zh_TW'}" />
      <label for="radio2">中国語(繁體字)</label>
      <input id="radio3" type="radio" name="i18n" value="en" th:checked="${i18n == 'en'}" />
      <label for="radio3">English</label>
      <button type="submit" id="save-i18n-btn" style="display:none;" th:text="#{button.save}">保存</button>
    </form>

    <div id="i18n-root" th:attr="data-current=${i18n}" style="display:none"></div>

    <script th:inline="javascript">
      /*<![CDATA[*/
      (function () {
        const form = document.getElementById('i18n-form');
        const saveBtn = document.getElementById('save-i18n-btn');
        const radios = Array.from(form.querySelectorAll('input[type="radio"][name="i18n"]'));
        const current = document.getElementById('i18n-root').dataset.current || 'ja';

        function updateSaveVisibility() {
          const selected = radios.find(r => r.checked).value;
          if (selected !== current) {
            saveBtn.style.display = '';
          } else {
            saveBtn.style.display = 'none';
          }
        }

        radios.forEach(r => r.addEventListener('change', updateSaveVisibility));
        updateSaveVisibility();
      })();
      /*]]>*/
    </script>

    <!-- data attributes for client-side alerts (filled from server via Thymeleaf) -->
    <script th:inline="javascript">
      /*<![CDATA[*/
      (function () {
        document.documentElement.setAttribute('data-alert-select', /*[[#{alert.selectGame}]]*/ 'Please select a game.');
        document.documentElement.setAttribute('data-alert-select-spectate', /*[[#{alert.selectSpectateFirst}]]*/ 'Please select a game first.');
        document.documentElement.setAttribute('data-alert-spectate-not-supported', /*[[#{alert.spectateNotSupported}]]*/ 'This game does not support spectate.');
      })();
      /*]]>*/
    </script>

</body>

</html>
